# --- 0. HTTPS Redirect ---
server {
    listen 80;
    listen [::]:80;
    server_name scheduler01.streamwrhu.net;

    # Redirect all HTTP to HTTPS
    return 301 https://$host$request_uri;
}

# --- 1. PUBLIC Playback Server (For Clients) ---
server {
    listen 443 ssl;
    http2 on;
    server_name scheduler01.streamwrhu.net;

    root /var/www/localhost/pi-encoder-scheduler/root/admin;
    index index.php phpinfo.php index.html;

    # --- SSL Config ---
    ssl_certificate /etc/letsencrypt/live/scheduler01.streamwrhu.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/scheduler01.streamwrhu.net/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # --- Gzip Config ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_types application/vnd.apple.mpegurl;
    gzip_comp_level 5;
    gzip_min_length 256;

    # --- Root Location ---
    location / {
        try_files $uri $uri/ /index.php?$query_string;
        add_header 'Cache-Control' 'no-cache, no-store, must-revalidate';
        add_header 'Expires' '0';
    }

    # --- MAIN PHP HANDLER ---
    location ~ \.php$ {
        # --- CORRECTION ---
        # Removed the duplicate 'try_files $uri =404;' line.
        # Your snippet file handles this.

        include snippets/fastcgi-php.conf;
        
        # Param order is still important
        include fastcgi_params;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # --- PHPMYADMIN Location ---
    location /myadmin/ {
        alias /usr/share/webapps/phpmyadmin/;
        index index.php index.html index.htm;

        location ~ ^/myadmin/(.+\.php)$ {
            # --- CORRECTION ---
            # Removed the duplicate 'try_files $uri =404;' line.
            
            include snippets/fastcgi-php.conf;
            include fastcgi_params;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
    }

    # --- Get Graphic Location ---
    location /graphic/ {
        alias /var/www/localhost/pi-encoder-scheduler/root/graphic;
        index get_graphic.php;

        location ~ ^/graphic/(.+\.php)$ {
            # --- CORRECTION ---
            # Removed the duplicate 'try_files $uri =440;' line.

            include snippets/fastcgi-php.conf;
            include fastcgi_params;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
    }
}