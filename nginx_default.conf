# --- 0. HTTPS Redirect ---
server {
    if ($host = scheduler01.streamwrhu.net) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    listen [::]:80;
    server_name scheduler01.streamwrhu.net;

    # Redirect all HTTP requests to HTTPS
    return 301 https://$host$request_uri;


}

# --- 1. PUBLIC Playback Server (For Clients) ---
server {
    listen 443 ssl;
    http2 on;
    server_name scheduler01.streamwrhu.net;

    # --- MAIN FIX 1: Set 'root' at the server level ---
    # This defines $document_root for the whole server.
    root /var/www/localhost/pi-encoder-scheduler/root/admin;

    # --- MAIN FIX 2: Set 'index' at the server level ---
    # Nginx will look for these files in the 'root' directory
    # when a request for / is made.
    index index.php phpinfo.php index.html;

    # --- SSL Config ---
    ssl_certificate /etc/letsencrypt/live/scheduler01.streamwrhu.net/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/scheduler01.streamwrhu.net/privkey.pem; # managed by Certbot
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # --- Gzip Config ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_types application/vnd.apple.mpegurl;
    gzip_comp_level 5;
    gzip_min_length 256;

    # --- Root Location ---
    location / {
        # --- MAIN FIX 3: Use try_files ---
        # This tries to find a file matching the URI ($uri),
        # then a directory ($uri/),
        # and if neither exists, it passes the request to index.php
        # (standard for most PHP apps).
        try_files $uri $uri/ /index.php?$query_string;

        # Your cache headers (these are fine)
        add_header 'Cache-Control' 'no-cache, no-store, must-revalidate';
        add_header 'Expires' '0';

        # --- MAIN FIX 4: Removed the incorrect nested PHP block ---
        # The main PHP handler below will take care of all .php files.
    }

    # --- MAIN PHP HANDLER ---
    # This block now works because $document_root is correctly set above.
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass 127.0.0.1:9000;

        # This line will now work correctly
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        include fastcgi_params;

        # Security fix: check if the PHP file exists before passing it to the backend
        #try_files $fastcgi_script_name =404;
    }

    # --- PHPMYADMIN Location ---
    location /myadmin/ {
        alias /usr/share/webapps/phpmyadmin/;
        index index.php index.html index.htm;

        # This nested location is correct for an aliased path
        location ~ ^/myadmin/(.+\.php)$ {
            alias /usr/share/webapps/phpmyadmin/$1;
            fastcgi_pass 127.0.0.1:9000;

            # $request_filename is correct here because of the alias
            fastcgi_param SCRIPT_FILENAME $request_filename;

            # Assuming fastcgi.conf is correct for your OS (e.g., Alpine)
            include fastcgi.conf;
        }
    }

    # --- Get Graphic Location ---
    location /get_graphic/ {
        alias /var/www/localhost/pi-encoder-scheduler/root/graphic;
        index get_graphic.php;

        # This nested location is correct for an aliased path
        location ~ ^/get_graphic/(.+\.php)$ {
            alias /var/www/localhost/pi-encoder-scheduler/root/graphic/$1;
            fastcgi_pass 127.0.0.1:9000;

            # $request_filename is correct here because of the alias
            fastcgi_param SCRIPT_FILENAME $request_filename;

            # Assuming fastcgi.conf is correct for your OS (e.g., Alpine)
            include fastcgi.conf;
        }
    }


}
